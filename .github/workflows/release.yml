name: Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [ closed ]

jobs:
  release:
    if: github.event_name == 'push' || (github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Tidy dependencies
      run: go mod tidy

    - name: Get version
      id: version
      run: |
        # Generate version based on commit count and short SHA
        VERSION="v$(git rev-list --count HEAD).$(git rev-parse --short HEAD)"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Build for Windows
      run: |
        # Build for Windows x64
        GOOS=windows GOARCH=amd64 go build -ldflags "-s -w" -o windows-config-builder.exe

    - name: Get file hash
      id: hash
      run: |
        HASH=$(sha256sum windows-config-builder.exe | cut -d' ' -f1)
        echo "sha256=$HASH" >> $GITHUB_OUTPUT
        echo "SHA256: $HASH"

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.version }}
        release_name: Release ${{ steps.version.outputs.version }}
        body: |
          ## Windows Configuration Builder
          
          Automated Windows development environment setup using winget package manager.
          
          **Requirements**: Windows 10/11 with winget installed
          
          ## Changes
          - Auto-generated release from commit ${{ github.sha }}
        draft: false
        prerelease: false

    - name: Upload Windows Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./windows-config-builder.exe
        asset_name: windows-config-builder.exe
        asset_content_type: application/octet-stream

  winget-submission:
    needs: release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout winget-pkgs fork
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository_owner }}/winget-pkgs
        token: ${{ secrets.GITHUB_TOKEN }}
        path: winget-pkgs

    - name: Get release info
      id: release_info
      run: |
        # Get the latest release info
        LATEST_RELEASE=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest)
        VERSION=$(echo $LATEST_RELEASE | jq -r '.tag_name')
        DOWNLOAD_URL=$(echo $LATEST_RELEASE | jq -r '.assets[0].browser_download_url')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT

    - name: Download and hash release
      id: download
      run: |
        wget -O windows-config-builder.exe "${{ steps.release_info.outputs.download_url }}"
        HASH=$(sha256sum windows-config-builder.exe | cut -d' ' -f1)
        echo "sha256=$HASH" >> $GITHUB_OUTPUT

    - name: Create winget manifest
      run: |
        VERSION="${{ steps.release_info.outputs.version }}"
        VERSION_NUM="${VERSION#v}"  # Remove 'v' prefix
        MANIFEST_DIR="winget-pkgs/manifests/A/Abelfubu/WindowsConfigBuilder/$VERSION_NUM"
        
        mkdir -p "$MANIFEST_DIR"
        
        # Create version manifest
        cat > "$MANIFEST_DIR/Abelfubu.WindowsConfigBuilder.yaml" << EOF
        # yaml-language-server: \$schema=https://aka.ms/winget-manifest.version.1.5.0.schema.json
        
        PackageIdentifier: Abelfubu.WindowsConfigBuilder
        PackageVersion: $VERSION_NUM
        DefaultLocale: en-US
        ManifestType: version
        ManifestVersion: 1.5.0
        EOF
        
        # Create installer manifest
        cat > "$MANIFEST_DIR/Abelfubu.WindowsConfigBuilder.installer.yaml" << EOF
        # yaml-language-server: \$schema=https://aka.ms/winget-manifest.installer.1.5.0.schema.json
        
        PackageIdentifier: Abelfubu.WindowsConfigBuilder
        PackageVersion: $VERSION_NUM
        MinimumOSVersion: 10.0.0.0
        InstallerType: portable
        Commands:
        - windows-config-builder
        Installers:
        - Architecture: x64
          InstallerUrl: ${{ steps.release_info.outputs.download_url }}
          InstallerSha256: ${{ steps.download.outputs.sha256 }}
        ManifestType: installer
        ManifestVersion: 1.5.0
        EOF
        
        # Create locale manifest
        cat > "$MANIFEST_DIR/Abelfubu.WindowsConfigBuilder.locale.en-US.yaml" << EOF
        # yaml-language-server: \$schema=https://aka.ms/winget-manifest.defaultLocale.1.5.0.schema.json
        
        PackageIdentifier: Abelfubu.WindowsConfigBuilder
        PackageVersion: $VERSION_NUM
        PackageLocale: en-US
        Publisher: Abelfubu
        PublisherUrl: https://github.com/${{ github.repository_owner }}
        PublisherSupportUrl: https://github.com/${{ github.repository }}/issues
        Author: Abel de la Fuente
        PackageName: Windows Config Builder
        PackageUrl: https://github.com/${{ github.repository }}
        License: MIT
        LicenseUrl: https://github.com/${{ github.repository }}/blob/main/LICENSE
        ShortDescription: Automated Windows development environment setup using winget package manager
        Description: |
          Windows Config Builder is a tool that automates the setup of a Windows development environment.
          It uses winget to install selected packages and creates configuration files for various tools
          including PowerShell, Starship, Neovim, and more.
        Moniker: windows-config-builder
        Tags:
        - automation
        - configuration
        - development
        - setup
        - winget
        - windows
        ManifestType: defaultLocale
        ManifestVersion: 1.5.0
        EOF

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        path: winget-pkgs
        commit-message: "Add Abelfubu.WindowsConfigBuilder version ${{ steps.release_info.outputs.version }}"
        title: "New package: Abelfubu.WindowsConfigBuilder version ${{ steps.release_info.outputs.version }}"
        body: |
          ## New Package Submission
          
          **Package**: Abelfubu.WindowsConfigBuilder
          **Version**: ${{ steps.release_info.outputs.version }}
          **Publisher**: Abelfubu
          
          ### Description
          Windows Config Builder is a tool that automates the setup of a Windows development environment using winget package manager.
          
          ### Validation
          - [x] Package builds and runs successfully
          - [x] Manifest files follow winget schema
          - [x] SHA256 hash verified
          
          ### Links
          - **Repository**: https://github.com/${{ github.repository }}
          - **Release**: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release_info.outputs.version }}
        branch: add-windows-config-builder-${{ steps.release_info.outputs.version }}
        delete-branch: true